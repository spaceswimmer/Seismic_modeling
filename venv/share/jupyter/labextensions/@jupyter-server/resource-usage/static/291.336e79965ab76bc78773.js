"use strict";(self.webpackChunk_jupyter_server_resource_usage=self.webpackChunk_jupyter_server_resource_usage||[]).push([[291],{291:(e,t,r)=>{r.r(t),r.d(t,{default:()=>G});var n=r(437),a=r(870),s=r(979),l=r(687),i=r(640),o=r(528),c=r(46),u=r(311),m=r(882),d=r(29),_=r.n(d),p=r(920),h=r(840);const v={B:1,KB:1024,MB:1048576,GB:1073741824,TB:1099511627776,PB:0x4000000000000};function g(e){const t=y(e);return t[0].toFixed(2)+" "+t[1]}function y(e){return e?e<v.KB?[e,"B"]:v.KB===e||e<v.MB?[e/v.KB,"KB"]:v.MB===e||e<v.GB?[e/v.MB,"MB"]:v.GB===e||e<v.TB?[e/v.GB,"GB"]:v.TB===e||e<v.PB?[e/v.TB,"TB"]:[e/v.PB,"PB"]:[0,"B"]}let C=null;const f=e=>{const{reason:t}=e;return"not_supported"===t.reason?_().createElement("div",{className:"jp-KernelUsage-section-separator"},e.trans.__("Please check with your system administrator that you are running IPyKernel version 6.10.0 or above."),t.kernel_version?e.trans.__("Detected IPyKernel version: %1",t.kernel_version):e.trans.__("No IPyKernel installation detected.")):"no_kernel_widget"===t.reason?_().createElement("div",{className:"jp-KernelUsage-section-separator"},e.trans.__("Switch to a notebook or console to see kernel usage details.")):"no_kernel"===t.reason?_().createElement("div",{className:"jp-KernelUsage-section-separator"},e.trans.__("No active kernel found.")):_().createElement("div",{className:"jp-KernelUsage-section-separator"},e.trans.__("Reason: %1.",t.reason))},k=e=>{var t;const{panel:r}=e,[n,a]=(0,d.useState)(),[s,l]=(0,d.useState)(),[i,o]=(0,d.useState)(),[c,u]=(0,d.useState)({reason:"loading"});((e,t)=>{const r=(0,d.useRef)();(0,d.useEffect)((()=>{r.current=e}),[e]),(0,d.useEffect)((()=>{if(null!==t){const e=setInterval((function(){r.current&&r.current()}),t);return()=>{clearInterval(e)}}}),[e,t])})((async()=>{n&&r.isVisible&&v(n).catch((()=>{console.warn(`Request failed for ${n}. Kernel restarting?`)}))}),5e3);const m=(0,d.useRef)(n);m.current=n;const v=e=>async function(e="",t={}){const r=h.ServerConnection.makeSettings(),n=p.URLExt.join(r.baseUrl,"api/metrics/v1/kernel_usage",e);let a;try{a=await h.ServerConnection.makeRequest(n,t,r)}catch(e){throw new h.ServerConnection.NetworkError(e)}let s=await a.text();if(s.length>0)try{s=JSON.parse(s)}catch(e){console.log("Not a JSON response body.",a)}if(!a.ok)throw new h.ServerConnection.ResponseError(a,s.message||s);return s}(`get_usage/${e}`).then((t=>{var r;if(e!==m.current)return;if(null===(r=t.content)||void 0===r?void 0:r.reason){const e=t.content;return void u(e)}u(void 0);const n={...t.content,timestamp:new Date,kernel_id:e};o(n)}));return(0,d.useEffect)((()=>{const t=e=>(t,r)=>{var n,s;const i=null===(n=r.newValue)||void 0===n?void 0:n.id;if(i){a(i);const t=null===(s=null==e?void 0:e.sessionContext.session)||void 0===s?void 0:s.model.path;l(t),v(i)}else u({reason:"no_kernel"}),a(i)},r=(e,r)=>{var s,i,c,m,d;if(null===r)return a(void 0),void u({reason:"no_kernel_widget"});if(C&&C.panel.sessionContext.kernelChanged.disconnect(C.callback),C={callback:t(r),panel:r},r.sessionContext.kernelChanged.connect(C.callback),(null===(i=null===(s=r.sessionContext.session)||void 0===s?void 0:s.kernel)||void 0===i?void 0:i.id)!==n){const e=null===(m=null===(c=r.sessionContext.session)||void 0===c?void 0:c.kernel)||void 0===m?void 0:m.id;if(e){a(e);const t=null===(d=r.sessionContext.session)||void 0===d?void 0:d.model.path;l(t),o(void 0),u({reason:"loading"}),v(e)}else a(void 0),u({reason:"no_kernel"})}};return e.tracker.currentChanged.connect(r),e.tracker.currentWidget&&r(e.tracker,e.tracker.currentWidget),()=>{e.tracker.currentChanged.disconnect(r)}}),[n]),c&&"timeout"!==(null==c?void 0:c.reason)&&"loading"!==(null==c?void 0:c.reason)?_().createElement(_().Fragment,null,_().createElement("h3",{className:"jp-KernelUsage-section-separator"},e.trans.__("Kernel usage not available")),_().createElement(f,{trans:e.trans,reason:c})):n?_().createElement(_().Fragment,null,_().createElement("h3",{className:"jp-KernelUsage-section-separator"},e.trans.__("Kernel usage")),"timeout"===(null==c?void 0:c.reason)?_().createElement("strong",null,e.trans.__("Timed out in: %1 ms",c.timeout_ms)):null,_().createElement("div",{className:"jp-KernelUsage-separator"},e.trans.__("Notebook:")," ",s),_().createElement("div",{className:"jp-KernelUsage-separator"},e.trans.__("Kernel ID:")," ",n),_().createElement("div",{className:"timeout"===(null==c?void 0:c.reason)?"jp-KernelUsage-timedOut":""},i?_().createElement(_().Fragment,null,_().createElement("div",{className:"jp-KernelUsage-separator"},e.trans.__("Kernel Host:")," ",i.hostname),_().createElement("div",{className:"jp-KernelUsage-separator"},e.trans.__("Timestamp:")," ",null===(t=i.timestamp)||void 0===t?void 0:t.toLocaleString()),_().createElement("div",{className:"jp-KernelUsage-separator"},e.trans.__("Process ID:")," ",i.pid),_().createElement("div",{className:"jp-KernelUsage-separator"},e.trans.__("CPU:")," ",i.kernel_cpu),_().createElement("div",{className:"jp-KernelUsage-separator"},e.trans.__("Memory:")," ",g(i.kernel_memory)),_().createElement("hr",{className:"jp-KernelUsage-section-separator"}),(null==i?void 0:i.host_usage_flag)?_().createElement(_().Fragment,null,_().createElement("h4",{className:"jp-KernelUsage-section-separator"},e.trans.__("Host CPU")),i.host_cpu_percent&&_().createElement("div",{className:"jp-KernelUsage-separator"},e.trans._n("%2%% used on %1 CPU","%2%% used on %1 CPUs",i.cpu_count,i.host_cpu_percent.toFixed(1))),_().createElement("h4",{className:"jp-KernelUsage-section-separator"},e.trans.__("Host Virtual Memory")),_().createElement("div",{className:"jp-KernelUsage-separator"},e.trans.__("Active:")," ",g(i.host_virtual_memory.active)),_().createElement("div",{className:"jp-KernelUsage-separator"},e.trans.__("Available:")," ",g(i.host_virtual_memory.available)),_().createElement("div",{className:"jp-KernelUsage-separator"},e.trans.__("Free:")," ",g(i.host_virtual_memory.free)),_().createElement("div",{className:"jp-KernelUsage-separator"},e.trans.__("Inactive:")," ",g(i.host_virtual_memory.inactive)),i.host_virtual_memory.percent&&_().createElement("div",{className:"jp-KernelUsage-separator"},e.trans.__("Percent used:")," ",i.host_virtual_memory.percent.toFixed(1),"%"),_().createElement("div",{className:"jp-KernelUsage-separator"},e.trans.__("Total:")," ",g(i.host_virtual_memory.total)),_().createElement("div",{className:"jp-KernelUsage-separator"},e.trans.__("Wired:")," ",g(i.host_virtual_memory.wired))):null):"loading"===(null==c?void 0:c.reason)?_().createElement("div",{className:"jp-KernelUsage-separator"},e.trans.__("Loadingâ€¦")):_().createElement("div",{className:"jp-KernelUsage-separator"},e.trans.__("Usage data is missing")))):_().createElement("h3",null,e.trans.__("Kernel usage is missing"))};class b extends a.ReactWidget{constructor(e){super(),this._tracker=e.tracker,this._panel=e.panel,this._trans=e.trans,this.addClass("jp-KernelUsage-content")}render(){return _().createElement(k,{tracker:this._tracker,panel:this._panel,trans:this._trans})}}const E='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\r\n  <g class="jp-icon3" fill="#616161">\r\n    <path d="m256 43c-141 0-256 115-256 256 0 62 22 118 59 163l6 8h383l6-8c37-44 59-101 59-163-0.1-141-115-256-256-256zm0 43c118 0 213 95 213 213 0 48-17 92-44 128h-339c-27-36-44-80-44-128 0-118 95-213 213-213zm0 21c-12 0-21 9.6-21 21s9.6 21 21 21 21-9.6 21-21-9.5-21-21-21zm-85 23c-12 0-21 9.6-21 21s9.6 21 21 21 21-9.6 21-21-9.6-21-21-21zm171 0c-12 0-21 9.6-21 21s9.6 21 21 21 21-9.6 21-21-9.5-21-21-21zm-233 63c-12 0-21 9.6-21 21s9.6 21 21 21 21-9.6 21-21-9.5-21-21-21zm290 0.7-121 69c-6.3-3.7-14-6-21-6-24 0-43 19-43 43s19 43 43 43c23 0 42-19 43-42v-0.7l121-69-21-37zm-313 85c-12 0-21 9.6-21 21s9.6 21 21 21 21-9.6 21-21-9.5-21-21-21zm341 0c-12 0-21 9.6-21 21s9.6 21 21 21 21-9.6 21-21-9.6-21-21-21zm-319 85c-12 0-21 9.6-21 21s9.6 21 21 21 21-9.6 21-21-9.5-21-21-21zm296 0c-12 0-21 9.6-21 21s9.6 21 21 21 21-9.6 21-21-9.5-21-21-21z"/>\r\n  </g>\r\n</svg>\r\n\x3c!-- Downloaded from https://seekicon.com/free-icon/tachometer-alt_1 under MIT License. --\x3e\r\n';class j extends m.StackedPanel{constructor(e){super(),this.addClass("jp-KernelUsage-view"),this.id="kernelusage-panel-id",this.title.caption=e.trans.__("Kernel Usage"),this.title.icon=new i.LabIcon({name:"jupyterlab-kernel-usage:icon",svgstr:E}),this.title.closable=!0;const t=new b({tracker:e.tracker,panel:this,trans:e.trans});this.addWidget(t)}dispose(){super.dispose()}onCloseRequest(e){super.onCloseRequest(e),this.dispose()}}var w,K,U=r(797);!function(e){class t extends a.VDomModel{constructor(e){super(),this._memoryAvailable=!1,this._cpuAvailable=!1,this._currentMemory=0,this._currentCpuPercent=0,this._memoryLimit=null,this._cpuLimit=null,this._units="B",this._warn=!1,this._values=[];for(let e=0;e<20;e++)this._values.push({memoryPercent:0,cpuPercent:0});this._poll=new U.Poll({factory:()=>K.factory(),frequency:{interval:e.refreshRate,backoff:!0},name:"@jupyterlab/statusbar:ResourceUsage#metrics"}),this._poll.ticked.connect((e=>{const{payload:t,phase:r}=e.state;if("resolved"!==r){if("rejected"===r){const e=this._memoryAvailable,t=this._cpuAvailable;return this._memoryAvailable=!1,this._cpuAvailable=!1,this._currentMemory=0,this._memoryLimit=null,this._cpuLimit=null,this._units="B",void((e||t)&&this.stateChanged.emit())}}else this._updateMetricsValues(t)}))}async refresh(){await this._poll.refresh(),await this._poll.tick}get metricsAvailable(){return this._memoryAvailable||this._cpuAvailable}get memoryAvailable(){return this._memoryAvailable}get cpuAvailable(){return this._cpuAvailable}get currentMemory(){return this._currentMemory}get memoryLimit(){return this._memoryLimit}get cpuLimit(){return this._cpuLimit}get units(){return this._units}get currentCpuPercent(){return this._currentCpuPercent}get values(){return this._values}get usageWarning(){return this._warn}dispose(){super.dispose(),this._poll.dispose()}_updateMetricsValues(e){var t,r,n;if(null===e)return this._memoryAvailable=!1,this._cpuAvailable=!1,this._currentMemory=0,this._memoryLimit=null,this._units="B",void(this._warn=!1);const a=null!==(t=e.pss)&&void 0!==t?t:e.rss,s=e.limits.memory,l=null!==(n=null!==(r=null==s?void 0:s.pss)&&void 0!==r?r:null==s?void 0:s.rss)&&void 0!==n?n:null,[i,o]=y(a),c=!!e.limits.memory&&e.limits.memory.warn;this._memoryAvailable=void 0!==a,this._currentMemory=i,this._units=o,this._memoryLimit=l?l/v[o]:null;const u=this.memoryLimit?Math.min(this._currentMemory/this.memoryLimit,1):0;this._warn=c,this._cpuLimit=e.limits.cpu?e.limits.cpu.cpu:null,this._cpuAvailable=void 0!==e.cpu_percent,this._currentCpuPercent=void 0!==e.cpu_percent?e.cpu_percent/100:0,this._values.push({memoryPercent:u,cpuPercent:this._currentCpuPercent}),this._values.shift(),this.stateChanged.emit(void 0)}}e.Model=t}(w||(w={})),function(e){const t=h.ServerConnection.makeSettings(),r=p.URLExt.join(t.baseUrl,"api/metrics/v1");e.factory=async()=>{const e=h.ServerConnection.makeRequest(r,{},t),n=await e;return n.ok?await n.json():null}}(K||(K={}));const N=(0,r(95).style)({fontSize:"var(--jp-ui-font-size1)",fontFamily:"var(--jp-ui-font-family)"},{backgroundColor:"#FFD2D2",color:"#D8000C"});class S extends a.VDomRenderer{constructor(e){super(new w.Model({refreshRate:5e3})),this._trans=e}render(){if(!this.model)return _().createElement("div",null);let e;return e=null===this.model.memoryLimit?this._trans.__("Mem: %1 %2",this.model.currentMemory.toFixed(B.DECIMAL_PLACES),this.model.units):this._trans.__("Mem: %1 / %2 %3",this.model.currentMemory.toFixed(B.DECIMAL_PLACES),this.model.memoryLimit.toFixed(B.DECIMAL_PLACES),this.model.units),this.model.cpuAvailable&&(e=`CPU: ${(100*this.model.currentCpuPercent).toFixed(B.DECIMAL_PLACES)} % ${e}`),this.model.usageWarning?_().createElement(c.TextItem,{title:this._trans.__("Current resource usage"),source:e,className:N}):_().createElement(c.TextItem,{title:this._trans.__("Current resource usage"),source:e})}}var B;!function(e){e.DECIMAL_PLACES=2}(B||(B={}));var P=r(901);function x(e){return e instanceof o.ConsolePanel||e instanceof l.NotebookPanel}class M{constructor(e){var t,r;this._currentWidget=null;const{labShell:n,notebookTracker:a,consoleTracker:s}=e;this._currentChanged=new P.Signal(this),n?n.currentChanged.connect(((e,t)=>{const r=t.newValue;r&&x(r)?(this._currentChanged.emit(r),this._currentWidget=r):(this._currentChanged.emit(null),this._currentWidget=null)})):(a.currentChanged.connect(((e,t)=>{this._currentChanged.emit(t),this._currentWidget=t})),s&&s.currentChanged.connect(((e,t)=>{this._currentChanged.emit(t),this._currentWidget=t}))),(null==n?void 0:n.currentWidget)&&x(null==n?void 0:n.currentWidget)?this._currentWidget=n.currentWidget:this._currentWidget=null!==(r=null!==(t=a.currentWidget)&&void 0!==t?t:null==s?void 0:s.currentWidget)&&void 0!==r?r:null}get currentChanged(){return this._currentChanged}get currentWidget(){return this._currentWidget}}var A=r(686);const L=({percentage:e,color:t})=>_().createElement("div",{className:"jp-IndicatorFiller",style:{width:100*e+"%",background:`${t}`}}),I=({values:e,percentage:t,baseColor:r})=>{const[n,a]=(0,d.useState)(!1),s=t>.5?t>.8?"red":"orange":r;return _().createElement("div",{className:"jp-IndicatorBar",onClick:()=>{a(!n)}},n&&_().createElement(A.Sparklines,{data:e,min:0,max:1,limit:e.length,margin:0},_().createElement(A.SparklinesLine,{style:{stroke:s,strokeWidth:4,fill:s,fillOpacity:1}}),_().createElement(A.SparklinesSpots,null)),!n&&_().createElement(L,{percentage:t,color:s}))},W=({enabled:e,values:t,label:r,color:n,text:a})=>{const s=t[t.length-1];return _().createElement(_().Fragment,null,e&&_().createElement("div",{className:"jp-IndicatorContainer"},_().createElement("div",{className:"jp-IndicatorText"},r),null!==s&&_().createElement("div",{className:"jp-IndicatorWrapper"},_().createElement(I,{values:t,percentage:s,baseColor:n})),_().createElement("div",{className:"jp-IndicatorText"},a)))},T=({model:e,label:t})=>{const[r,n]=(0,d.useState)(""),[a,s]=(0,d.useState)([]),l=()=>{const{cpuLimit:t,currentCpuPercent:r}=e,a=e.values.map((e=>Math.min(1,e.cpuPercent/(t||1)))),l=`${(100*r).toFixed(0)}%`;n(l),s(a)};return(0,d.useEffect)((()=>(e.stateChanged.connect(l),()=>{e.stateChanged.disconnect(l)})),[e]),_().createElement(W,{enabled:e.cpuAvailable,values:a,label:t,color:"#0072B3",text:r})};var R;!function(e){e.createCpuView=(e,t)=>a.ReactWidget.create(_().createElement(T,{model:e,label:t}))}(R||(R={}));const F=({model:e,label:t})=>{const[r,n]=(0,d.useState)(""),[a,s]=(0,d.useState)([]),l=()=>{const{memoryLimit:t,currentMemory:r,units:a}=e,l=["B","KB","MB"].indexOf(a)>0?0:2,i=`${r.toFixed(l)} ${t?"/ "+t.toFixed(l):""} ${a}`,o=e.values.map((e=>e.memoryPercent));n(i),s(o)};return(0,d.useEffect)((()=>(e.stateChanged.connect(l),()=>{e.stateChanged.disconnect(l)})),[e]),_().createElement(W,{enabled:e.memoryAvailable,values:a,label:t,color:"#00B35B",text:r})};var D,z;!function(e){e.createMemoryView=(e,t)=>a.ReactWidget.create(_().createElement(F,{model:e,label:t}))}(D||(D={})),function(e){e.getKernelUsage="kernel-usage:get"}(z||(z={}));const V={id:"@jupyter-server/resource-usage:status-item",autoStart:!0,requires:[u.ITranslator],optional:[c.IStatusBar],activate:(e,t,r)=>{const n=t.load("jupyter-resource-usage"),a=new S(n);r&&r.registerStatusItem(V.id,{item:a,align:"left",rank:2,isActive:()=>a.model.metricsAvailable,activeStateChanged:a.model.stateChanged})}},q={id:"@jupyter-server/resource-usage:topbar-item",autoStart:!0,requires:[a.IToolbarWidgetRegistry],optional:[s.ISettingRegistry],activate:async(e,t,r)=>{let n=!1,a=5e3,s="CPU: ",l="Mem: ";if(r){const e=await r.load(q.id);n=e.get("enable").composite,a=e.get("refreshRate").composite;const t=e.get("cpu").composite;s=t.label;const i=e.get("memory").composite;l=i.label}const i=new w.Model({refreshRate:a});await i.refresh(),n&&i.cpuAvailable&&t.addFactory("TopBar","cpu",(()=>R.createCpuView(i,s))),n&&i.memoryAvailable&&t.addFactory("TopBar","memory",(()=>D.createMemoryView(i,l)))}},$={id:"@jupyter-server/resource-usage:kernel-panel-item",autoStart:!0,optional:[a.ICommandPalette,n.ILabShell,o.IConsoleTracker],requires:[u.ITranslator,l.INotebookTracker],activate:(e,t,r,n,a,s)=>{const l=t.load("jupyter-resource-usage"),{commands:o,shell:c}=e,u=l.__("Kernel Resource");let m=null;function d(){if(!m||m.isDisposed){const e=new M({notebookTracker:r,labShell:a,consoleTracker:s});m=new j({tracker:e,trans:l}),c.add(m,"right",{rank:200})}}o.addCommand(z.getKernelUsage,{label:l.__("Kernel Usage"),caption:l.__("Kernel Usage"),icon:new i.LabIcon({name:"jupyterlab-kernel-usage:icon",svgstr:E}),execute:d}),n&&n.addItem({command:z.getKernelUsage,category:u}),d()}},G=[V,q,$]}}]);